---
# --- Debian/Ubuntu/Raspbian ---
- name: Install dependencies (Debian)
  ansible.builtin.package:
    name:
      - curl
      - gpg
      - procps
    state: present
  when: ansible_os_family == "Debian"

- name: Add Tailscale GPG key (Debian)
  ansible.builtin.get_url:
    url: "https://pkgs.tailscale.com/stable/{{ ansible_distribution | lower }}/{{ ansible_distribution_release }}.noarmor.gpg"
    dest: /usr/share/keyrings/tailscale-archive-keyring.gpg
    mode: '0644'
  when: ansible_os_family == "Debian"

- name: Add Tailscale repository (Debian)
  ansible.builtin.apt_repository:
    repo: "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/{{ ansible_distribution | lower }} {{ ansible_distribution_release }} main"
    filename: tailscale
    state: present
  when: ansible_os_family == "Debian"

- name: Update apt cache and install Tailscale (Debian)
  ansible.builtin.apt:
    name: tailscale
    state: present
    update_cache: yes
  when: ansible_os_family == "Debian"

# --- Arch Linux ---
- name: Install Tailscale and dependencies (Arch)
  community.general.pacman:
    name:
      - tailscale
    state: present
    update_cache: yes
  when: ansible_os_family == "Archlinux"

# --- Service Management ---
- name: Enable and start Tailscaled
  ansible.builtin.systemd:
    name: tailscaled
    state: started
    enabled: yes

# --- Configuration ---
# --- Configuration ---
- name: Enable IPv4 forwarding
  ansible.builtin.sysctl:
    name: net.ipv4.ip_forward
    value: '1'
    sysctl_file: /etc/sysctl.d/99-tailscale.conf
    state: present
    reload: yes

- name: Enable IPv6 forwarding
  ansible.builtin.sysctl:
    name: net.ipv6.conf.all.forwarding
    value: '1'
    sysctl_file: /etc/sysctl.d/99-tailscale.conf
    state: present
    reload: yes

- name: Wait for Tailscale service to be ready
  ansible.builtin.command: tailscale status --json
  register: ts_ready_check
  until: ts_ready_check.rc == 0
  retries: 20
  delay: 3
  changed_when: false
  ignore_errors: true

- name: Configure Tailscale to advertise exit node
  ansible.builtin.command:
    cmd: tailscale set --advertise-exit-node
  changed_when: false

- name: Initialize Tailscale backend state
  ansible.builtin.set_fact:
    ts_backend_state: 'Stopped'

- name: Check current Tailscale status
  ansible.builtin.command: tailscale status --json
  register: tailscale_status_json
  failed_when: false # Don't fail if tailscale returns non-zero (e.g. not logged in)
  changed_when: false # This task only gathers info, doesn't change state

- name: Parse Tailscale status to check backend state
  ansible.builtin.set_fact:
    ts_backend_state: "{{ (tailscale_status_json.stdout | from_json)['BackendState'] }}"
  # Only run this if the previous command was successful and output looks like JSON
  when: 
    - tailscale_status_json.rc == 0
    - tailscale_status_json.stdout | length > 0
    - (tailscale_status_json.stdout | trim | first) == '{'
  ignore_errors: true

- name: Run 'tailscale up' with auth key if not connected/running
  ansible.builtin.command: >
    tailscale up --auth-key={{ ts_auth_key }} --hostname={{ hostname }} --advertise-exit-node --accept-routes
  # Use the 'when' condition to check if the state is not 'Running'
  when: ts_backend_state | default('Stopped') != 'Running'
  register: tailscale_up_result
  # Use "no_log: true" to prevent sensitive auth key from appearing in logs
  # no_log: true
  # This task changes the system state, so it should report changes
  changed_when: tailscale_up_result.rc == 0
